# Noeta Comprehensive Test - Core Operations
# Tests operations with canonical unified syntax v2.0
# Data: sales_data.csv, titanic.csv
# Last Updated: December 14, 2025

# ============================================================
# SECTION 1: Data I/O
# ============================================================

load "data/sales_data.csv" as sales
load "data/titanic.csv" as titanic

# ============================================================
# SECTION 2: Selection & Projection
# ============================================================

select sales {product_id, category, price, quantity} as sales_subset
select_by_type titanic with type="numeric" as titanic_numeric
head sales_subset with n=10 as sales_top10
tail sales_subset with n=5 as sales_bottom5
rename sales_subset {product_id: prod_id, category: cat} as sales_renamed

# ============================================================
# SECTION 3: Filtering
# ============================================================

filter sales where price > 100 as expensive_sales
filter sales where price between 50 and 200 as mid_range_sales
filter titanic where Age is null as missing_age
filter titanic where Age is not null as has_age

# ============================================================
# SECTION 4: Math Operations
# ============================================================

round sales column price with decimals=2 as sales_rounded_price
abs sales column price as sales_abs_price
sqrt sales column quantity as sales_sqrt_qty
power sales column quantity with exponent=2 as sales_qty_squared
log sales column price with base=10 as sales_log_price
ceil sales column price as sales_ceil_price
floor sales column price as sales_floor_price

# ============================================================
# SECTION 5: String Operations
# ============================================================

upper titanic column Name as titanic_upper_name
lower titanic column Name as titanic_lower_name
length titanic column Name as titanic_name_len
title titanic column Name as titanic_title_name

# ============================================================
# SECTION 6: Type & Encoding
# ============================================================

astype sales column quantity with dtype="int64" as sales_qty_int
to_numeric sales column price with errors="coerce" as sales_price_numeric
one_hot_encode sales column category as sales_onehot
label_encode sales column category as sales_label_encoded

# ============================================================
# SECTION 7: Scaling & Normalization
# ============================================================

normalize sales columns {price, quantity} with method=zscore as sales_normalized
standard_scale sales columns {price, quantity} as sales_standard_scaled
minmax_scale sales columns {price, quantity} as sales_minmax_scaled
robust_scale sales columns {price, quantity} as sales_robust_scaled
maxabs_scale sales columns {price, quantity} as sales_maxabs_scaled

# ============================================================
# SECTION 8: Cleaning Operations
# ============================================================

fillna titanic column Age with value=30 as titanic_filled_age
fillna titanic column Age with method="mean" as titanic_filled_mean
dropna titanic as titanic_no_na
isnull titanic column Age as titanic_age_null
notnull titanic column Age as titanic_age_notnull
interpolate titanic column Age with method="linear" as titanic_interpolated
duplicated titanic as titanic_dup_mask

# ============================================================
# SECTION 9: Reshaping
# ============================================================

pivot sales with index=product_id columns=category values=price as sales_pivot
melt sales_subset with id_vars={product_id} value_vars={price, quantity} as sales_melted
transpose sales_subset as sales_transposed

# ============================================================
# SECTION 10: Grouping & Aggregation
# ============================================================

groupby sales by {category} compute {sum: price, count: product_id} as sales_by_cat
groupby sales by {category} as sales_grouped

# ============================================================
# SECTION 11: Binning
# ============================================================

binning sales column price with bins=5 as sales_price_binned
cut sales column price with bins=5 as sales_price_cut

# ============================================================
# SECTION 12: Cumulative Operations
# ============================================================

cumsum sales column quantity as sales_cumsum_qty
cummax sales column price as sales_cummax_price
cummin sales column price as sales_cummin_price
cumprod sales column quantity as sales_cumprod_qty

# ============================================================
# SECTION 13: Time Series
# ============================================================

pct_change sales column price with periods=1 as sales_pct_change
diff sales column price with periods=1 as sales_diff
shift sales column price with periods=1 fill_value=0 as sales_shifted

# ============================================================
# SECTION 14: Index Operations
# ============================================================

set_index sales column product_id as sales_indexed
reset_index sales_indexed as sales_reset
sort_index sales_indexed as sales_sorted_idx

# ============================================================
# SECTION 15: Window Functions
# ============================================================

rank sales column price as sales_price_rank
dense_rank sales column price as sales_price_dense_rank
row_number sales as sales_row_num
percent_rank sales column price as sales_price_pct_rank
ntile sales column price with n=4 as sales_price_quartile
lag sales column price with periods=1 as sales_price_lag
lead sales column price with periods=1 as sales_price_lead

# ============================================================
# SECTION 16: Statistical Operations
# ============================================================

describe sales
summary sales
info sales
corr sales columns {price, quantity}
cov sales columns {price, quantity}
value_counts sales column category as category_counts
unique sales column category as unique_cats
quantile sales column price with q=0.75
outliers sales with method=iqr columns {price, quantity}
count_na titanic column Age
count_duplicates titanic
sample sales with n=10 random as sales_sample

# ============================================================
# SECTION 17: Sorting
# ============================================================

sort sales by price desc as sales_sorted_price
sort sales by category asc as sales_sorted_cat

# ============================================================
# SECTION 18: Rolling Operations
# ============================================================

rolling sales column price with window=3 function=mean as sales_rolling_mean
expanding sales column price with function=sum as sales_expanding_sum

# ============================================================
# SECTION 19: Validation
# ============================================================

assert_unique sales column product_id
assert_no_nulls sales column price
assert_range sales column price with min=0 max=10000

# ============================================================
# SECTION 20: Boolean Operations
# ============================================================

any titanic_age_null as any_null_age
all titanic_age_notnull as all_not_null
count_true titanic_age_null as count_null_age

# ============================================================
# SECTION 21: Visualization
# ============================================================

boxplot sales columns {price, quantity}
heatmap sales columns {price, quantity}
pairplot sales columns {price, quantity}
pie sales with values=quantity labels=product_id

# ============================================================
# SECTION 22: Save Operations
# ============================================================

save sales_subset to "output/test_output.csv"

# ============================================================
# TEST COMPLETE - All operations use canonical unified syntax
# ============================================================
